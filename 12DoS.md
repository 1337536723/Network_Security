#  拒绝访问攻击(DoS)

## 拒绝访问攻击(DoS)与分布式拒绝访问攻击(DDoS)

### DoS攻击
- 故意攻击网络协议的缺陷或直接通过某种手段耗尽被攻击对象的资源，目的是让目标计算机或网络无法提供正常的服务或资源访问，使目标系统服务停止响应甚至崩溃
    - 而且攻击者会利用发送数据和接收数据大小的不对称性进行攻击

- 从原理上来说，无论攻击者的攻击目标(服务器、计算机或网络服务)的处理速度多快、内存容量多大、网络带宽的速度多快都无法避免这种攻击带来的后果。任何资源都有一个极限，所以攻击者总能找到一个方法使请求的值大于该极限值，导致所提供的服务资源耗尽
    - 而且服务器设计者普遍认为全世界的人同时访问是不可能发生的

- 但是随着计算机性能和网络性能的提升，一般要用一台电脑攻陷另外一台就很难，而且容易被发现

### DDoS攻击
- DDoS是在传统的DoS攻击基础之上产生的一种新的攻击方式称为“分布式拒绝服务攻击”

- 就技术实现方式来分析，分布式拒绝服务攻击就是攻击者利用入侵手段，控制几百台，或者成千上万台计算机(一般这些被称为“肉鸡”)，然后在这些计算机上安装大量的DDoS程序。这些程序接受来自攻击者的控制命令，攻击者同时启动全部傀儡主机向目标服务器发起拒绝服务攻击，形成一个DoS攻击群，猛烈的攻击目标，这样能极为暴力的将原本处理能力很强的目标服务器攻陷。

- 有效而且基本无法抵挡，而且很难发现幕后黑手

## 拒绝访问攻击的原理、实现方式及防御手段

- DoS攻击的两种方式
    - DoS bug：利用现有协议的缺陷达到攻击的目的
    - DoS flood：想办法产生大量泛洪的数据包

- DoS攻击也可能发生在各个层次
    - 数据链路层
    - TCP/IP层
    - 应用层

### Wi-Fi上的解除身份验证攻击
- 接入点会验证发起“身份验证”的客户机

- 但是却不会验证发起“解除身份验证”(De-authentication)的客户机

- 可以利用这个bug达到DoS攻击的目的

![0](https://raw.githubusercontent.com/familyld/Network_Security/master/graph/DoS1.png)

### ICMP广播攻击
- 攻击者可以冒充一个IP向一个网段广播ICMP包（也就是ping该网段的广播地址）
- 所有该网段的主机都会回复到那个假冒的IP地址上

![1](https://raw.githubusercontent.com/familyld/Network_Security/master/graph/DoS2.png)

### DNS放大攻击（反射攻击）
- 一般来说，DNS查询(query)包的大小比DNS反馈包的大小小得多（一般有50倍的差别）

- 通过利用这一点攻击者可以冒充一个IP发送DNS查询

![2](https://raw.githubusercontent.com/familyld/Network_Security/master/graph/DoS3.png)

### 针对DNS服务器的攻击
- 多台机器频繁向DNS服务器发请求，让服务器疲于响应

- DNS之所以成为黑客攻击的首选目标主要有三个原因
    - 服务角色决定了DNS具有稳定性和公开性，加之缓存影响导致地址不能经常变化，故不能更换和隐藏IP地址
    - 其次是匿名性，DNS服务使用UDP协议，黑客可以很好地隐藏自己不被追溯
    - 最后就是集中性，通常情况下DNS 服务器都会为多个网站或者用户提供服务，攻破一个服务器影响范围非常大，也使得攻击效率大大提高

- 解决方案
    - CoDONS(Cooperative Domain Name System)或者使用p2p技术
        - 其根本目的是将DNS服务器连在一起平衡流量

### TCP SYN 泛洪攻击
- 利用TCP协议缺陷，发送大量伪造的TCP连接请求，从而使得被攻击方资源耗尽

- 问题出在TCP连接的三次握手中，假设一个用户向服务器发送了SYN报文后突然死机或掉线，那么服务器在发出SYN+ACK应答报文后是无法收到客户端的ACK报文的（第三次握手无法完成），这种情况下服务器端一般会重试（再次 发送SYN+ACK给客户端）并等待一段时间后丢弃这个未完成的连接，这段时间的长度我们称为SYNTimeout，一般这个时间是分钟的数量级

- 如果有一个恶意的攻击者大量模拟这种情况，服务器端将为了维护一个非常大的半连接列表而消耗非常多的资源。好一点的就忙于处理这些半连接而无暇理会用户的正常请求，但一般情况下会堆栈溢出而崩溃

- 解决方法
    - 直接弃用这个端口
        - windowsupdate.com -> windowsupdate.microsoft.com
    - 缩短SYN timeout时长
        - 看似很好，但是万一真的发生了掉线的情况…
    - SYN Cookie
        - 给每一个请求连接的IP地址分配一个Cookie，然后将这一Cookie(里面有TCP半连接的信息)发给客户机
            - 当客户机收到并回复确认(确认带有半连接的信息)的时候才进行后续的TCP连接
            - 从而服务器不需要保存半连接
        - DDoS基本没法防范

- 解决方法
    - TCP Proxy连接代理技术
        - 在接受到客户端发起的TCP请求时，防火墙产品本身将充当代理，率先和客户端保持会话建立的过程。如果完整的三次握手报文没有收到，防火墙将丢弃该会话连接请求，同时也不会和后端服务器建立会话连接，只有三次握手成功的连接请求，才会传递到后端的服务器并完成会话的建立

![3](https://raw.githubusercontent.com/familyld/Network_Security/master/graph/DoS4.png)

### HTTP GET 攻击
- 攻击者可能通过单主机构造多个IP地址，并和服务器建立正常的TCP连接，之后不断的向目标服务器特定页面发起HTTP GET请求，实现诸如数据库的注册、查询、刷新等操作以消耗服务器资源，当发送的频率足够高的时候将导致服务器侧忙于响应这些请求导致CPU资源不足，从 而使得其他的正常请求得不到处理。

- 这种攻击TCP Proxy连接代理就没办法防范（因为真的建立了TCP连接），但是却很好解决
    - 由于在这过程中必须使用建立连接的IP地址方可通信，因此可以限制某一地址客户机不能频繁进行请求
        - 可以将频繁进行请求的客户机限速或者拉黑

### 基于JS的DDoS攻击
- JAVA SCRIPT的一个重要应用就是嵌入在WEB页面里面，执行一些静态WEB页面标记语言（HTML）无法完成的功能。这些脚本在带来方便和强大功能的同时，也为攻击者提供了方便的攻击途径。如果攻击者写一些对系统有破坏的SCRIPT，然后嵌入在 WEB页面中，一旦这些页面被下载到本地，计算机便以当前用户的权限（最高权限，并且自动执行）执行这些脚本，这样，当前用户所具有的任何权限，SCRIPT都可以使用，使得计算机容易被攻击，成为“肉鸡”。

![4](https://raw.githubusercontent.com/familyld/Network_Security/master/graph/DoS5.png)

### 基于应用层的DDoS攻击
- SSL/TLS秘钥交换攻击：在SSL进行秘钥交换时如果发送方连续发送随机数，服务器将疲于计算秘钥值

![5](https://raw.githubusercontent.com/familyld/Network_Security/master/graph/DoS6.png)

#### SSL/TLS秘钥交换攻击
- 解决办法
    - 给客户机出题，以减缓客户机的攻击速度
        - 要求服务器能很快检查出答案，当服务器收到客户机发来的答案验证正确后再进行秘钥交换
        - 但是导致计算能力不强的客户机（比如手机）可能因此连接不上

    - 验证码
        - 验证对方是不是人发出的请求

    - 数据源验证
        - 验证发送方的IP，只接受受验证的IP的请求
        - 但实际上IP可以伪造

        - 追踪技术

##### 追踪技术
- 如果让路由器可以记录下包的转发信息，那么就可以实现对于源的回溯
    - 最简单的方法：把整体条路径写到IP包里面去
        - 但是需要IP里面有很多地方给你写（目前是没有的）
        - 而且长度不定
    - 好一点的方法：只记录上一跳的位置
    - 更进一步的办法：基本概率包标记
